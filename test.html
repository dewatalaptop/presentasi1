<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dolan Sawah ‚Äî Strategic Data Intelligence System (Production v3.1)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<style>
/* ==========================================================================
   1. GLOBAL VARIABLES & RESET
   ========================================================================== */
:root {
  /* Color Palette - Neon Cyberpunk Style */
  --bg-color: #050505;
  --text-main: #ffffff;
  --text-muted: rgba(255, 255, 255, 0.5);
  
  /* Brand Colors */
  --accent-green: #00ff99;  /* Growth/Positive */
  --accent-blue: #33ccff;   /* Info/Neutral */
  --accent-red: #ff0050;    /* Alert/Attention */
  --accent-purple: #bc13fe; /* Premium/Member */

  /* UI Components */
  --card-bg: rgba(255, 255, 255, 0.05);
  --card-border: 1px solid rgba(255, 255, 255, 0.1);
  --glass-blur: blur(10px);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  background-color: var(--bg-color);
  color: var(--text-main);
  overflow: hidden; /* Mencegah scrollbar, menggunakan slide */
  height: 100vh;
  width: 100vw;
}

/* ==========================================================================
   2. SLIDE LAYOUT & ANIMATION
   ========================================================================== */
.slide {
  display: none; /* Default hidden */
  height: 100vh;
  width: 100vw;
  padding: clamp(20px, 5vw, 60px);
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  position: absolute;
  top: 0;
  left: 0;
}

.slide.active {
  display: flex;
  animation: slideIn 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
  z-index: 10;
}

@keyframes slideIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ==========================================================================
   3. TYPOGRAPHY
   ========================================================================== */
h1 {
  font-size: clamp(36px, 6vw, 72px);
  margin-bottom: 25px;
  line-height: 1.1;
  letter-spacing: -1px;
}

h2 {
  font-size: clamp(24px, 4vw, 42px);
  margin-bottom: 30px;
  font-weight: 600;
  color: #eeeeee;
}

h3 {
  font-size: 18px;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--accent-green);
  margin-bottom: 15px;
  width: 100%;
}

p {
  font-size: clamp(16px, 2vw, 24px);
  max-width: 900px;
  line-height: 1.6;
  color: var(--text-muted);
}

.highlight { color: var(--accent-green); font-weight: 700; }
.text-blue { color: var(--accent-blue); }
.text-red { color: var(--accent-red); }

/* ==========================================================================
   4. GRID & CARD SYSTEM
   ========================================================================== */
.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 25px;
  width: 100%;
  max-width: 1200px;
  margin-top: 30px;
}

.card {
  background: var(--card-bg);
  border: var(--card-border);
  backdrop-filter: var(--glass-blur);
  -webkit-backdrop-filter: var(--glass-blur);
  border-radius: 20px;
  padding: 30px;
  position: relative;
  overflow: hidden;
  transition: transform 0.3s ease;
}

/* Visual Bar Progress */
.progress-bar {
  height: 8px;
  background: rgba(255,255,255,0.1);
  border-radius: 4px;
  margin-top: 15px;
  overflow: hidden;
}
.progress-fill {
  height: 100%;
  width: 0;
  background: var(--accent-green);
  transition: width 1.5s ease-out;
}

/* ==========================================================================
   5. DATA VISUALIZATION SPECIFIC
   ========================================================================== */
.dashboard-wrapper {
  width: 100%;
  max-width: 1100px;
  text-align: left;
}

.chart-container {
  position: relative;
  height: 250px;
  width: 100%;
  margin-top: 15px;
}

/* UX: Loading Overlay for Charts */
.chart-loading {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.2);
    font-size: 14px;
    color: var(--text-muted);
    z-index: 5;
    transition: opacity 0.3s;
}
.chart-loading.hidden {
    opacity: 0;
    pointer-events: none;
}

/* KPI Boxes (Big Numbers) */
.kpi-container {
  display: flex;
  gap: 20px;
  margin-bottom: 20px;
}

.kpi-box {
  flex: 1;
  background: rgba(0,0,0,0.3);
  padding: 20px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.05);
}

.kpi-value {
  font-size: 2.5rem;
  font-weight: 700;
  color: #fff;
  margin-bottom: 5px;
}

.kpi-label {
  font-size: 0.85rem;
  text-transform: uppercase;
  color: var(--text-muted);
  letter-spacing: 1px;
}

/* List Styles for Menu/Ranking */
ul.data-list {
  list-style: none;
  max-height: 250px;
  overflow-y: auto;
}
ul.data-list li {
  padding: 12px 0;
  border-bottom: 1px solid rgba(255,255,255,0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
}
ul.data-list li:last-child { border-bottom: none; }

/* ==========================================================================
   6. NAVIGATION & FOOTER
   ========================================================================== */
.controls {
  position: fixed;
  bottom: 30px;
  right: 30px;
  display: flex;
  gap: 15px;
  z-index: 100;
}

.btn-nav {
  width: 50px; height: 50px;
  border-radius: 50%;
  border: 1px solid rgba(255,255,255,0.3);
  background: rgba(0,0,0,0.6);
  color: #fff;
  font-size: 20px;
  cursor: pointer;
  transition: all 0.3s;
}
.btn-nav:hover {
  background: var(--accent-green);
  color: #000;
  border-color: var(--accent-green);
}

.footer {
  position: fixed;
  bottom: 30px;
  left: 30px;
  font-size: 12px;
  color: var(--text-muted);
  display: flex;
  align-items: center;
  gap: 10px;
}

.status-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  background: #555;
  box-shadow: 0 0 0 2px rgba(255,255,255,0.1);
}
.status-dot.online { background: var(--accent-green); box-shadow: 0 0 10px var(--accent-green); }
.status-dot.error { background: var(--accent-red); }

/* Backgrounds */
.cinematic {
  background-size: cover;
  background-position: center;
}
.cinematic::after {
  content: "";
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.6);
  z-index: 1;
}
.cinematic > * { position: relative; z-index: 2; }
</style>
</head>

<body>

<div class="slide active">
  <h1>Dolan Sawah</h1>
  <p>Strategic Marketing & Competitive Playbook</p>
  <div style="margin-top: 20px; padding: 8px 20px; border: 1px solid var(--text-muted); border-radius: 30px; font-size: 12px;">
    System Version 3.1 (Enhanced Logic)
  </div>
</div>

<div class="slide">
  <h2>Masalah Nyata</h2>
  <p>
    Liburan selesai.<br>
    Trafik menurun.<br>
    <span class="highlight">Ini bukan kegagalan.</span>
  </p>
</div>

<div class="slide">
  <h2>Ini Pola Industri</h2>
  <p>
    Semua resto wisata mengalaminya.<br>
    Yang bertahan bukan yang viral,<br>
    tapi yang <span class="highlight">relevan.</span>
  </p>
</div>

<div class="slide">
  <h1>Warung Kinasih</h1>
  <p>Dekat secara lokasi.<br>Berbeda secara model bisnis.</p>
</div>

<div class="slide">
  <h2>Kenapa Mereka Viral?</h2>
  <div class="grid">
    <div class="card">
      Harga mudah diviralkan
      <div class="progress-bar"><div class="progress-fill" style="width:90%"></div></div>
    </div>
    <div class="card">
      Visual instan
      <div class="progress-bar"><div class="progress-fill" style="width:85%"></div></div>
    </div>
    <div class="card">
      Konten mudah ditiru
      <div class="progress-bar"><div class="progress-fill" style="width:95%"></div></div>
    </div>
  </div>
</div>

<div class="slide">
  <h2>Insight Kritis</h2>
  <p>
    Mereka menjual <span class="highlight">sensasi pertama</span>,<br>
    bukan pengalaman berulang.
  </p>
</div>

<div class="slide">
  <h2>Dampak ke Area</h2>
  <p>
    Orang datang. Antre. Lelah.<br>
    Mulai mencari <span class="highlight">alternatif.</span>
  </p>
</div>

<div class="slide">
  <h2>Perbandingan Jujur</h2>
  <div class="grid">
    <div class="card">
      <b style="color:var(--accent-red)">Kinasih</b><br><br>
      Cepat<br>Padat<br>FOMO<br>Sekali datang
    </div>
    <div class="card">
      <b class="highlight">Dolan Sawah</b><br><br>
      Luas<br>Santai<br>Experience<br>Repeat tinggi
    </div>
  </div>
</div>

<div class="slide">
  <h2>Kesalahan Umum</h2>
  <p>
    Meniru viral.<br>
    Padahal kita menang di <span class="highlight">kenyamanan.</span>
  </p>
</div>

<div class="slide">
  <h1>Positioning Baru</h1>
  <p class="highlight">‚ÄúTempat kembali setelah resto viral.‚Äù</p>
</div>

<div class="slide">
  <h2>Maknanya</h2>
  <p>
    Kita tidak melawan kompetitor.<br>
    Kita <span class="highlight">melengkapi perjalanan pelanggan.</span>
  </p>
</div>

<div class="slide">
  <h1>Strategi Marketing</h1>
  <p>Bukan ramai.<br>Tapi <span class="highlight">relevan di momen tepat.</span></p>
</div>

<div class="slide">
  <h2>Pilar Strategi</h2>
  <div class="grid">
    <div class="card">Visibility<br><span class="highlight">Mudah ditemukan</span></div>
    <div class="card">Contrast<br><span class="highlight">Jelas berbeda</span></div>
    <div class="card">Convenience<br><span class="highlight">Tanpa friksi</span></div>
    <div class="card">Repeat Value<br><span class="highlight">Layak kembali</span></div>
  </div>
</div>

<div class="slide">
  <h2>Taktik Utama</h2>
  <p>
    Saat kompetitor menciptakan keramaian,<br>
    kita menciptakan <span class="highlight">jalan keluar.</span>
  </p>
</div>

<div class="slide">
  <h1>Eksekusi 30 Hari</h1>
  <p>Strategi ini harus terasa<br><span class="highlight">dalam 4 minggu.</span></p>
</div>

<div class="slide">
  <h2>Minggu 1 ‚Äî Visibility & Trust</h2>
  <p>
    ‚Ä¢ Update Google Business<br>
    ‚Ä¢ Konten area luas & view<br>
    ‚Ä¢ Tone: tenang & keluarga
  </p>
</div>

<div class="slide">
  <h2>Minggu 2 ‚Äî Contrast & Capture</h2>
  <p>
    ‚Ä¢ Konten kontras (ramai vs lapang)<br>
    ‚Ä¢ Geo ads sekitar kompetitor<br>
    ‚Ä¢ CTA: tanpa antre
  </p>
</div>

<div class="slide">
  <h2>Minggu 3 ‚Äî Value & Repeat</h2>
  <p>
    ‚Ä¢ Paket keluarga / menu hero<br>
    ‚Ä¢ Promo weekday ringan<br>
    ‚Ä¢ Dorong review Google
  </p>
</div>

<div class="slide">
  <h2>Minggu 4 ‚Äî Optimize & Scale</h2>
  <p>
    ‚Ä¢ Matikan konten gagal<br>
    ‚Ä¢ Gandakan konten perform<br>
    ‚Ä¢ Kunci SOP konten
  </p>
</div>

<div class="slide">
  <h1>KPI Marketing</h1>
  <p>Tanpa data,<br>strategi hanya opini.</p>
</div>

<div class="slide">
  <h2>KPI Utama</h2>
  <div class="grid">
    <div class="card">Traffic Weekday<div class="progress-bar"><div class="progress-fill" style="width:70%"></div></div></div>
    <div class="card">Avg Transaction<div class="progress-bar"><div class="progress-fill" style="width:60%"></div></div></div>
    <div class="card">Repeat Customer<div class="progress-bar"><div class="progress-fill" style="width:55%"></div></div></div>
    <div class="card">Google Rating<div class="progress-bar"><div class="progress-fill" style="width:85%"></div></div></div>
  </div>
</div>

<div class="slide">
    <div class="dashboard-wrapper">
        <h2>üìà Operational Intelligence: Revenue</h2>
        <p>Analisis tren pendapatan dari Down Payment (DP) reservasi.</p>
        
        <div class="kpi-container">
            <div class="kpi-box">
                <div class="kpi-label">Total Reservasi (YTD)</div>
                <div class="kpi-value highlight" id="valTotalRes">0</div>
            </div>
            <div class="kpi-box">
                <div class="kpi-label">Est. Omzet DP</div>
                <div class="kpi-value text-blue" id="valTotalRev">Rp 0</div>
            </div>
            <div class="kpi-box">
                <div class="kpi-label">Data Status</div>
                <div class="kpi-value" style="font-size:1.2rem; margin-top:10px; color:#aaa;">Synced</div>
            </div>
        </div>

        <div class="card">
            <div class="chart-container">
                <div id="loader-revenue" class="chart-loading"><span>Sedang Mengunduh Data...</span></div>
                <canvas id="chartRevenue"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="slide">
    <div class="dashboard-wrapper">
        <h2>üçΩÔ∏è Operational Intelligence: Product</h2>
        <p>Data preferensi pelanggan berdasarkan riwayat pesanan.</p>

        <div class="grid" style="grid-template-columns: 2fr 1fr;">
            <div class="card">
                <h3>Menu Terlaris (Top 7)</h3>
                <div class="chart-container">
                    <div id="loader-menu" class="chart-loading"><span>Analisis Data Menu...</span></div>
                    <canvas id="chartMenu"></canvas>
                </div>
            </div>

            <div class="card">
                <h3>Leaderboard</h3>
                <ul class="data-list" id="listMenu">
                    <li><span style="color:#666">Menunggu sinkronisasi...</span></li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="slide">
    <div class="dashboard-wrapper">
        <h2>üì¢ Growth Engine: Acquisition</h2>
        <p>Efektivitas kanal marketing dalam mendatangkan member baru.</p>

        <div class="grid" style="grid-template-columns: 1fr 1fr; align-items:center;">
            <div class="card">
                <div class="chart-container" style="height: 300px;">
                    <div id="loader-source" class="chart-loading"><span>Mengambil Data Member...</span></div>
                    <canvas id="chartSource"></canvas>
                </div>
            </div>

            <div style="padding-left: 20px;">
                <div class="kpi-box" style="margin-bottom:20px;">
                    <div class="kpi-label">Total Member Terdaftar</div>
                    <div class="kpi-value text-blue" id="valTotalMember">0</div>
                </div>
                
                <div class="card" style="padding:20px;">
                    <h3 style="font-size:14px; color:#fff;">Marketing Insight:</h3>
                    <p style="font-size:16px;">
                        ‚Ä¢ Dominasi <span class="highlight">TikTok/IG</span> menandakan konten viral bekerja.<br>
                        ‚Ä¢ Dominasi <span class="text-blue">Google Maps</span> menandakan SEO lokal kuat.<br>
                        ‚Ä¢ Fokuskan budget iklan pada kanal dengan persentase tertinggi.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="slide">
    <div class="dashboard-wrapper">
        <h2>üìç Growth Engine: Geo-Location</h2>
        <p>Peta sebaran domisili pelanggan untuk penargetan iklan.</p>

        <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; gap:15px; margin-bottom:20px;">
            <div class="card" style="padding:15px; text-align:center;">
                <div class="kpi-label">Kota Semarang</div>
                <div class="kpi-value highlight" id="geo1">0%</div>
            </div>
            <div class="card" style="padding:15px; text-align:center;">
                <div class="kpi-label">Kabupaten</div>
                <div class="kpi-value text-blue" id="geo2">0%</div>
            </div>
            <div class="card" style="padding:15px; text-align:center;">
                <div class="kpi-label">Luar Kota</div>
                <div class="kpi-value text-red" id="geo3">0%</div>
            </div>
        </div>

        <div class="card">
            <h3>Visualisasi Sebaran Wilayah</h3>
            <div class="chart-container" style="height: 200px;">
                <div id="loader-geo" class="chart-loading"><span>Memetakan Lokasi...</span></div>
                <canvas id="chartGeo"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="slide">
  <h1>Brand Manifesto</h1>
  <p>Kami tidak mengejar viral.</p>
</div>

<div class="slide">
  <p>
    Kami percaya makan adalah pengalaman.<br>
    Ruang untuk keluarga.<br>
    Waktu untuk berbincang.<br>
    Tempat untuk kembali.
  </p>
</div>

<div class="slide cinematic" style="background-image:url('https://images.unsplash.com/photo-1528605248644-14dd04022da1')">
  <h1>Dolan Sawah</h1>
  <p>Lebih dari sekadar makan.</p>
</div>

<div class="slide cinematic" style="background-image:url('https://images.unsplash.com/photo-1504674900247-0877df9cc836')">
  <h1>Penutup</h1>
  <p><span class="highlight">Viral lewat. Experience tinggal.</span></p>
</div>


<div class="controls">
  <button class="btn-nav" onclick="prevSlide()">‚óÄ</button>
  <button class="btn-nav" onclick="nextSlide()">‚ñ∂</button>
</div>

<div class="footer">
    <span class="status-dot" id="dbIndicator"></span>
    <span id="dbStatusText">Initializing Database...</span>
    <span style="opacity:0.3">|</span>
    <span>Dolan Sawah Intelligence System</span>
</div>

<script>
// =======================================================
// 1. CONFIGURATION: DUAL FIREBASE DATABASE
// =======================================================

// Konfigurasi Database 1: RESERVASI (Untuk Data Omzet & Menu)
const configReservasi = {
  apiKey: "AIzaSyA_c1tU70FM84Qi_f_aSaQ-YVLo_18lCkI",
  authDomain: "reservasi-dolan-sawah.firebaseapp.com",
  projectId: "reservasi-dolan-sawah",
  storageBucket: "reservasi-dolan-sawah.appspot.com",
  messagingSenderId: "213151400721",
  appId: "1:213151400721:web:e51b0d8cdd24206cf682b0"
};

// Konfigurasi Database 2: MEMBER (Untuk Data Member & Source)
const configMember = {
  apiKey: "AIzaSyAEzWDI9ZWlc7NnUTDBbx7wednnUVeS9Ao",
  authDomain: "member-hp-dolansawah.firebaseapp.com",
  projectId: "member-hp-dolansawah",
  storageBucket: "member-hp-dolansawah.appspot.com",
  messagingSenderId: "277683917105",
  appId: "1:277683917105:web:d496ee4547f339e2fee010"
};

// Global Variables
let dbReservasi, dbMember;
let chartInstances = {}; // Menyimpan instance chart agar bisa di-resize (Point 2B)

// =======================================================
// 2. HELPER FUNCTIONS (Point 2C & Point 4)
// =======================================================

// Fix 2C: Robust Date Parser (Handle Firestore Timestamp & String)
function parseDateHelper(dateInput) {
    if (!dateInput) return null;
    
    // Jika input adalah Firestore Timestamp (memiliki method toDate)
    if (typeof dateInput.toDate === 'function') {
        return dateInput.toDate();
    }
    
    // Jika input sudah berupa object Date standard
    if (dateInput instanceof Date) {
        return dateInput;
    }
    
    // Jika input string/number, coba convert
    const parsed = new Date(dateInput);
    if (!isNaN(parsed)) return parsed;
    
    return null;
}

// Fix 4: Professional IDR Formatting
function formatRupiah(number) {
    return new Intl.NumberFormat('id-ID', { 
        style: 'currency', 
        currency: 'IDR',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(number);
}

// UI Helpers: Show/Hide Loaders
function hideLoader(id) {
    const el = document.getElementById(id);
    if(el) el.classList.add('hidden');
}

// =======================================================
// 3. SYSTEM INITIALIZATION
// =======================================================

function initSystem() {
    try {
        // Inisialisasi App Reservasi
        const appRes = firebase.initializeApp(configReservasi, "AppReservasi");
        dbReservasi = appRes.firestore();
        
        // Inisialisasi App Member
        const appMem = firebase.initializeApp(configMember, "AppMember");
        dbMember = appMem.firestore();
        
        // Update UI Status
        updateStatus("Online: Connected to Dual DB", "online");
        
        // Mulai Tarik Data
        fetchAllData();

    } catch (error) {
        console.error("Initialization Failed:", error);
        updateStatus("Connection Failed!", "error");
    }
}

function updateStatus(text, statusClass) {
    const dot = document.getElementById('dbIndicator');
    const txt = document.getElementById('dbStatusText');
    
    dot.className = "status-dot " + statusClass;
    txt.innerText = text;
}

// =======================================================
// 4. DATA FETCHING & PROCESSING
// =======================================================

async function fetchAllData() {
    // --- STEP A: Fetch Reservasi ---
    try {
        const snapRes = await dbReservasi.collection('reservations').get();
        const dataRes = snapRes.docs.map(doc => doc.data());
        
        processRevenue(dataRes);
        processMenu(dataRes);
        
    } catch (e) {
        console.error("Error Reservasi:", e);
        updateStatus("Error Reading Reservation DB", "error");
    }

    // --- STEP B: Fetch Member ---
    try {
        const snapMem = await dbMember.collection('members').get();
        const dataMem = snapMem.docs.map(doc => doc.data());
        
        processMemberStats(dataMem);
        processGeo(dataMem);

    } catch (e) {
        console.error("Error Member:", e);
        updateStatus("Error Reading Member DB", "error");
    }
}

// =======================================================
// 5. DATA LOGIC PROCESSORS
// =======================================================

// --- LOGIC 1: Revenue (Chart Line) ---
function processRevenue(data) {
    const months = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Ags", "Sep", "Okt", "Nov", "Des"];
    const revenueData = new Array(12).fill(0);
    let totalRev = 0;

    data.forEach(r => {
        if(r.date && r.dp) {
            // Apply Fix 2C: Gunakan helper date parser
            const d = parseDateHelper(r.date);
            const val = parseInt(r.dp);
            
            if(d && !isNaN(val)) {
                revenueData[d.getMonth()] += val;
                totalRev += val;
            }
        }
    });

    // Update KPI (Fix 4: Better Formatting)
    document.getElementById('valTotalRes').innerText = data.length.toLocaleString('id-ID');
    document.getElementById('valTotalRev').innerText = formatRupiah(totalRev);

    // Render Chart
    hideLoader('loader-revenue');
    chartInstances.revenue = new Chart(document.getElementById('chartRevenue'), {
        type: 'line',
        data: {
            labels: months,
            datasets: [{
                label: 'Omzet DP',
                data: revenueData,
                borderColor: '#00ff99',
                backgroundColor: 'rgba(0, 255, 153, 0.1)',
                borderWidth: 3,
                tension: 0.4,
                fill: true,
                pointRadius: 4,
                pointBackgroundColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: {display: false} },
            scales: {
                y: { grid: {color:'rgba(255,255,255,0.1)'}, ticks: {callback: v => (v/1000) + 'k', color:'#888'} },
                x: { grid: {display:false}, ticks: {color:'#ccc'} }
            }
        }
    });
}

// --- LOGIC 2: Menu (Chart Bar Horizontal) ---
function processMenu(data) {
    const menuCount = {};
    
    data.forEach(r => {
        if(Array.isArray(r.menus)) {
            r.menus.forEach(m => {
                const name = m.name;
                const qty = parseInt(m.quantity) || 1;
                menuCount[name] = (menuCount[name] || 0) + qty;
            });
        } 
        else if (r.menu) {
            menuCount[r.menu] = (menuCount[r.menu] || 0) + 1;
        }
    });

    const sorted = Object.entries(menuCount).sort((a,b) => b[1]-a[1]).slice(0, 7);

    // Update List HTML
    const listEl = document.getElementById('listMenu');
    listEl.innerHTML = "";
    sorted.forEach(([name, count]) => {
        listEl.innerHTML += `
            <li>
                <span style="font-weight:500;">${name}</span>
                <span class="highlight">${count}</span>
            </li>
        `;
    });

    // Render Chart
    hideLoader('loader-menu');
    chartInstances.menu = new Chart(document.getElementById('chartMenu'), {
        type: 'bar',
        data: {
            labels: sorted.map(i => i[0].substring(0, 12) + '...'),
            datasets: [{
                label: 'Qty',
                data: sorted.map(i => i[1]),
                backgroundColor: '#33ccff',
                borderRadius: 4
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: {display: false} },
            scales: {
                x: { grid: {color:'rgba(255,255,255,0.1)'}, ticks: {color:'#888'} },
                y: { grid: {display:false}, ticks: {color:'#fff'} }
            }
        }
    });
}

// --- LOGIC 3: Member Source (Chart Doughnut) ---
function processMemberStats(data) {
    document.getElementById('valTotalMember').innerText = data.length.toLocaleString('id-ID');

    const sources = {};
    data.forEach(m => {
        let s = (m.sumberInfo || "Lainnya").toLowerCase();
        if(s.includes('ig') || s.includes('instagram')) s = 'Instagram';
        else if(s.includes('tik')) s = 'TikTok';
        else if(s.includes('google') || s.includes('maps')) s = 'Google Maps';
        else s = 'Lainnya';
        
        sources[s] = (sources[s] || 0) + 1;
    });

    hideLoader('loader-source');
    chartInstances.source = new Chart(document.getElementById('chartSource'), {
        type: 'doughnut',
        data: {
            labels: Object.keys(sources),
            datasets: [{
                data: Object.values(sources),
                backgroundColor: ['#E1306C', '#000000', '#4285F4', '#888'],
                borderColor: '#222',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'right', labels: {color:'#fff', padding:15} }
            },
            layout: { padding: 20 }
        }
    });
}

// --- LOGIC 4: Geo Location (Chart Bar + KPI) ---
function processGeo(data) {
    const geo = { 'Semarang': 0, 'Kabupaten': 0, 'Luar Kota': 0 };
    
    data.forEach(m => {
        const addr = (m.alamat || "").toLowerCase();
        if(addr.includes('semarang') && !addr.includes('kab')) geo['Semarang']++;
        else if(addr.includes('kab') && addr.includes('semarang')) geo['Kabupaten']++;
        else geo['Luar Kota']++;
    });

    const total = data.length || 1;
    document.getElementById('geo1').innerText = Math.round((geo['Semarang']/total)*100) + "%";
    document.getElementById('geo2').innerText = Math.round((geo['Kabupaten']/total)*100) + "%";
    document.getElementById('geo3').innerText = Math.round((geo['Luar Kota']/total)*100) + "%";

    hideLoader('loader-geo');
    chartInstances.geo = new Chart(document.getElementById('chartGeo'), {
        type: 'bar',
        data: {
            labels: ['Kota Semarang', 'Kab. Semarang', 'Luar Kota'],
            datasets: [{
                data: [geo['Semarang'], geo['Kabupaten'], geo['Luar Kota']],
                backgroundColor: ['#00ff99', '#33ccff', '#ff0050'],
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: {display: false} },
            scales: {
                y: { grid: {color:'rgba(255,255,255,0.1)'}, ticks: {color:'#888'} },
                x: { grid: {display:false}, ticks: {color:'#fff'} }
            }
        }
    });
}

// =======================================================
// 6. NAVIGATION CONTROLLER
// =======================================================
let slides = document.querySelectorAll('.slide');
let currentSlide = 0;

function showSlide(n) {
    slides.forEach(s => {
        s.classList.remove('active');
        s.style.display = 'none'; 
    });
    
    currentSlide = (n + slides.length) % slides.length;
    
    const activeSlide = slides[currentSlide];
    activeSlide.style.display = 'flex'; 
    
    // Trigger animation
    setTimeout(() => {
        activeSlide.classList.add('active');
        
        // Fix 2B: Force Resize Chart pada elemen tersembunyi
        // Kita loop semua chart, jika canvasnya ada di slide ini, kita resize
        Object.values(chartInstances).forEach(chart => {
            if (activeSlide.contains(chart.canvas)) {
                chart.resize(); 
                chart.update('none'); // Update tanpa animasi ulang yang mengganggu
            }
        });

    }, 10);
}

function nextSlide() { showSlide(currentSlide + 1); }
function prevSlide() { showSlide(currentSlide - 1); }

// Keyboard Listener
document.addEventListener('keydown', (e) => {
    if(e.key === "ArrowRight" || e.key === " " || e.key === "Enter") nextSlide();
    if(e.key === "ArrowLeft") prevSlide();
});

// Jalankan Sistem
initSystem();

</script>
</body>
</html>
