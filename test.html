<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dolan Sawah ‚Äî Strategic Data Intelligence System (Production v3.2)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<style>
/* ==========================================================================
   1. GLOBAL VARIABLES & RESET
   ========================================================================== */
:root {
  /* Color Palette - Neon Cyberpunk Style */
  --bg-color: #000000;
  --text-main: #ffffff;
  --text-muted: rgba(255, 255, 255, 0.6);
  
  /* Brand Colors */
  --accent-green: #00ff99;  /* Growth/Positive */
  --accent-blue: #33ccff;   /* Info/Neutral */
  --accent-red: #ff0050;    /* Alert/Attention */
  --accent-purple: #bc13fe; /* Premium/Member */
  --accent-orange: #ff9900; /* Salatiga/Special */

  /* UI Components */
  --card-bg: rgba(255, 255, 255, 0.08);
  --card-border: 1px solid rgba(255, 255, 255, 0.1);
  --glass-blur: blur(20px);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  background-color: var(--bg-color);
  color: var(--text-main);
  overflow: hidden; 
  height: 100vh;
  width: 100vw;
  perspective: 1000px;
}

/* ==========================================================================
   2. SLIDE LAYOUT & ANIMATION
   ========================================================================== */
.slide {
  display: none; 
  height: 100vh;
  width: 100vw;
  padding: clamp(20px, 5vw, 60px);
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  position: absolute;
  top: 0;
  left: 0;
  opacity: 0;
  transform: scale(1.1) translateY(20px); 
  filter: blur(10px);
  transition: 
    opacity 0.8s ease, 
    transform 1.0s cubic-bezier(0.19, 1, 0.22, 1), 
    filter 0.8s ease;
}

.slide.active {
  display: flex;
  opacity: 1;
  transform: scale(1) translateY(0);
  filter: blur(0);
  z-index: 10;
}

.slide.active h1,
.slide.active h2,
.slide.active p,
.slide.active .grid,
.slide.active .dashboard-wrapper {
  animation: appleFadeUp 1s cubic-bezier(0.19, 1, 0.22, 1) forwards;
  opacity: 0;
  transform: translateY(30px);
}

.slide.active h1 { animation-delay: 0.1s; }
.slide.active h2 { animation-delay: 0.1s; }
.slide.active h3 { animation-delay: 0.2s; }
.slide.active p  { animation-delay: 0.3s; }
.slide.active .grid { animation-delay: 0.5s; }
.slide.active .dashboard-wrapper { animation-delay: 0.2s; }

@keyframes appleFadeUp {
  to { opacity: 1; transform: translateY(0); }
}

/* ==========================================================================
   3. TYPOGRAPHY
   ========================================================================== */
h1 {
  font-size: clamp(48px, 7vw, 96px);
  margin-bottom: 25px;
  line-height: 1.05;
  letter-spacing: -2px;
  font-weight: 700;
  background: linear-gradient(180deg, #fff 0%, #aaa 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

h2 {
  font-size: clamp(32px, 5vw, 56px);
  margin-bottom: 30px;
  font-weight: 600;
  color: #eeeeee;
  letter-spacing: -1px;
}

h3 {
  font-size: 18px;
  text-transform: uppercase;
  letter-spacing: 3px;
  color: var(--accent-green);
  margin-bottom: 20px;
  width: 100%;
  font-weight: 600;
}

p {
  font-size: clamp(20px, 2.5vw, 32px);
  max-width: 1000px;
  line-height: 1.5;
  color: var(--text-muted);
  font-weight: 400;
}

.highlight { color: var(--accent-green); font-weight: 600; }
.text-blue { color: var(--accent-blue); }
.text-red { color: var(--accent-red); }
.text-orange { color: var(--accent-orange); }

/* ==========================================================================
   4. GRID & CARD SYSTEM
   ========================================================================== */
.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 30px;
  width: 100%;
  max-width: 1300px;
  margin-top: 40px;
}

.card {
  background: var(--card-bg);
  border: var(--card-border);
  backdrop-filter: var(--glass-blur);
  -webkit-backdrop-filter: var(--glass-blur);
  border-radius: 24px;
  padding: 35px;
  position: relative;
  overflow: hidden;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  transition: transform 0.4s ease, background 0.4s ease;
}

.card:hover {
  background: rgba(255,255,255,0.12);
  transform: translateY(-5px);
}

.progress-bar {
  height: 10px;
  background: rgba(255,255,255,0.1);
  border-radius: 6px;
  margin-top: 20px;
  overflow: hidden;
}
.progress-fill {
  height: 100%;
  width: 0;
  background: var(--accent-green);
  transition: width 2s cubic-bezier(0.22, 1, 0.36, 1);
  box-shadow: 0 0 10px var(--accent-green);
}

/* ==========================================================================
   5. DATA VISUALIZATION SPECIFIC
   ========================================================================== */
.dashboard-wrapper {
  width: 100%;
  max-width: 1200px;
  text-align: left;
}

.chart-container {
  position: relative;
  height: 300px;
  width: 100%;
  margin-top: 20px;
}

.chart-loading {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.4);
    font-size: 14px;
    color: var(--text-muted);
    z-index: 5;
    transition: opacity 0.5s;
    backdrop-filter: blur(5px);
    border-radius: 20px;
}
.chart-loading.hidden { opacity: 0; pointer-events: none; }

.kpi-container {
  display: flex;
  gap: 25px;
  margin-bottom: 25px;
}

.kpi-box {
  flex: 1;
  background: rgba(255,255,255,0.03);
  padding: 25px;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,0.05);
  text-align: center; /* Center align for geo stats */
}

.kpi-value {
  font-size: 2.5rem; /* Adjusted for multiple boxes */
  font-weight: 700;
  color: #fff;
  margin-bottom: 5px;
  letter-spacing: -1px;
}

.kpi-label {
  font-size: 0.85rem;
  text-transform: uppercase;
  color: var(--text-muted);
  letter-spacing: 1.5px;
  font-weight: 500;
}

ul.data-list {
  list-style: none;
  max-height: 280px;
  overflow-y: auto;
  padding-right: 10px;
}
ul.data-list::-webkit-scrollbar { width: 5px; }
ul.data-list::-webkit-scrollbar-thumb { background: #333; border-radius: 5px; }

ul.data-list li {
  padding: 15px 0;
  border-bottom: 1px solid rgba(255,255,255,0.08);
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 1.1rem;
}
ul.data-list li:last-child { border-bottom: none; }

/* ==========================================================================
   6. NAVIGATION & FOOTER
   ========================================================================== */
.controls {
  position: fixed;
  bottom: 40px;
  right: 40px;
  display: flex;
  gap: 20px;
  z-index: 100;
  opacity: 0.6;
  transition: opacity 0.3s;
}
.controls:hover { opacity: 1; }

.btn-nav {
  width: 60px; height: 60px;
  border-radius: 50%;
  border: 1px solid rgba(255,255,255,0.2);
  background: rgba(20,20,20,0.8);
  color: #fff;
  font-size: 24px;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.19, 1, 0.22, 1);
  display: flex;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(10px);
}
.btn-nav:hover {
  transform: scale(1.1);
  background: #fff;
  color: #000;
  border-color: #fff;
}

.footer {
  position: fixed;
  bottom: 40px;
  left: 40px;
  font-size: 13px;
  color: var(--text-muted);
  display: flex;
  align-items: center;
  gap: 12px;
  background: rgba(0,0,0,0.5);
  padding: 10px 20px;
  border-radius: 30px;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.05);
}

.status-dot {
  width: 10px; height: 10px;
  border-radius: 50%;
  background: #555;
  box-shadow: 0 0 0 2px rgba(255,255,255,0.1);
  transition: background 0.3s;
}
.status-dot.online { background: var(--accent-green); box-shadow: 0 0 15px var(--accent-green); }
.status-dot.error { background: var(--accent-red); }

.cinematic {
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
}
.cinematic::after {
  content: "";
  position: absolute;
  inset: 0;
  background: linear-gradient(to bottom, rgba(0,0,0,0.3), rgba(0,0,0,0.8));
  z-index: 1;
}
.cinematic > * { position: relative; z-index: 2; text-shadow: 0 10px 30px rgba(0,0,0,0.8); }
</style>
</head>

<body>

<div class="slide active">
  <h1>Dolan Sawah</h1>
  <p>Strategic Marketing & Competitive Playbook</p>
  <div style="margin-top: 30px; padding: 10px 25px; border: 1px solid var(--text-muted); border-radius: 50px; font-size: 14px; letter-spacing: 1px; text-transform: uppercase;">
    System Version 3.2 (Geo-Location Enhanced)
  </div>
</div>

<div class="slide">
  <h2>Masalah Nyata</h2>
  <p>Liburan selesai. Trafik menurun.<br><span class="highlight">Ini bukan kegagalan.</span></p>
</div>

<div class="slide">
  <h2>Ini Pola Industri</h2>
  <p>Semua resto wisata mengalaminya.<br>Yang bertahan bukan yang viral, tapi yang <span class="highlight">relevan.</span></p>
</div>

<div class="slide">
  <h1>Warung Kinasih</h1>
  <p>Dekat secara lokasi.<br>Berbeda secara model bisnis.</p>
</div>

<div class="slide">
  <h2>Kenapa Mereka Viral?</h2>
  <div class="grid">
    <div class="card">Harga mudah diviralkan<div class="progress-bar"><div class="progress-fill" style="width:90%"></div></div></div>
    <div class="card">Visual instan<div class="progress-bar"><div class="progress-fill" style="width:85%"></div></div></div>
    <div class="card">Konten mudah ditiru<div class="progress-bar"><div class="progress-fill" style="width:95%"></div></div></div>
  </div>
</div>

<div class="slide">
  <h2>Insight Kritis</h2>
  <p>Mereka menjual <span class="highlight">sensasi pertama</span>,<br>bukan pengalaman berulang.</p>
</div>

<div class="slide">
  <h2>Dampak ke Area</h2>
  <p>Orang datang. Antre. Lelah.<br>Mulai mencari <span class="highlight">alternatif.</span></p>
</div>

<div class="slide">
  <h2>Perbandingan Jujur</h2>
  <div class="grid">
    <div class="card"><b style="color:var(--accent-red); font-size:1.5rem;">Kinasih</b><br><br>Cepat, Padat, FOMO, Sekali datang</div>
    <div class="card" style="border-color: var(--accent-green);"><b class="highlight" style="font-size:1.5rem;">Dolan Sawah</b><br><br>Luas, Santai, Experience, Repeat tinggi</div>
  </div>
</div>

<div class="slide">
  <h2>Kesalahan Umum</h2>
  <p>Meniru viral. Padahal kita menang di <span class="highlight">kenyamanan.</span></p>
</div>

<div class="slide">
  <h1>Positioning Baru</h1>
  <p class="highlight">‚ÄúTempat kembali setelah resto viral.‚Äù</p>
</div>

<div class="slide">
  <h2>Maknanya</h2>
  <p>Kita tidak melawan kompetitor.<br>Kita <span class="highlight">melengkapi perjalanan pelanggan.</span></p>
</div>

<div class="slide">
  <h1>Strategi Marketing</h1>
  <p>Bukan ramai. Tapi <span class="highlight">relevan di momen tepat.</span></p>
</div>

<div class="slide">
  <h2>Pilar Strategi</h2>
  <div class="grid">
    <div class="card">Visibility<br><span class="highlight">Mudah ditemukan</span></div>
    <div class="card">Contrast<br><span class="highlight">Jelas berbeda</span></div>
    <div class="card">Convenience<br><span class="highlight">Tanpa friksi</span></div>
    <div class="card">Repeat Value<br><span class="highlight">Layak kembali</span></div>
  </div>
</div>

<div class="slide">
  <h2>Taktik Utama</h2>
  <p>Saat kompetitor menciptakan keramaian,<br>kita menciptakan <span class="highlight">jalan keluar.</span></p>
</div>

<div class="slide">
  <h1>Eksekusi 30 Hari</h1>
  <p>Strategi ini harus terasa <span class="highlight">dalam 4 minggu.</span></p>
</div>

<div class="slide">
  <h2>Minggu 1 ‚Äî Visibility & Trust</h2>
  <p>‚Ä¢ Update Google Business<br>‚Ä¢ Konten area luas & view<br>‚Ä¢ Tone: tenang & keluarga</p>
</div>

<div class="slide">
  <h2>Minggu 2 ‚Äî Contrast & Capture</h2>
  <p>‚Ä¢ Konten kontras (ramai vs lapang)<br>‚Ä¢ Geo ads sekitar kompetitor<br>‚Ä¢ CTA: tanpa antre</p>
</div>

<div class="slide">
  <h2>Minggu 3 ‚Äî Value & Repeat</h2>
  <p>‚Ä¢ Paket keluarga / menu hero<br>‚Ä¢ Promo weekday ringan<br>‚Ä¢ Dorong review Google</p>
</div>

<div class="slide">
  <h2>Minggu 4 ‚Äî Optimize & Scale</h2>
  <p>‚Ä¢ Matikan konten gagal<br>‚Ä¢ Gandakan konten perform<br>‚Ä¢ Kunci SOP konten</p>
</div>

<div class="slide">
  <h1>KPI Marketing</h1>
  <p>Tanpa data, strategi hanya opini.</p>
</div>

<div class="slide">
  <h2>KPI Utama</h2>
  <div class="grid">
    <div class="card">Traffic Weekday<div class="progress-bar"><div class="progress-fill" style="width:70%"></div></div></div>
    <div class="card">Avg Transaction<div class="progress-bar"><div class="progress-fill" style="width:60%"></div></div></div>
    <div class="card">Repeat Customer<div class="progress-bar"><div class="progress-fill" style="width:55%"></div></div></div>
    <div class="card">Google Rating<div class="progress-bar"><div class="progress-fill" style="width:85%"></div></div></div>
  </div>
</div>

<div class="slide">
    <div class="dashboard-wrapper">
        <h2>üìà Operational Intelligence: Revenue</h2>
        <p>Analisis tren pendapatan dari Down Payment (DP) reservasi.</p>
        
        <div class="kpi-container">
            <div class="kpi-box">
                <div class="kpi-label">Total Reservasi (YTD)</div>
                <div class="kpi-value highlight" id="valTotalRes">0</div>
            </div>
            <div class="kpi-box">
                <div class="kpi-label">Est. Omzet DP</div>
                <div class="kpi-value text-blue" id="valTotalRev">Rp 0</div>
            </div>
            <div class="kpi-box">
                <div class="kpi-label">Data Status</div>
                <div class="kpi-value" style="font-size:1.5rem; margin-top:10px; color:#aaa;">Synced</div>
            </div>
        </div>

        <div class="card">
            <div class="chart-container">
                <div id="loader-revenue" class="chart-loading"><span>Sedang Mengunduh Data...</span></div>
                <canvas id="chartRevenue"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="slide">
    <div class="dashboard-wrapper">
        <h2>üçΩÔ∏è Operational Intelligence: Product</h2>
        <p>Data preferensi pelanggan berdasarkan riwayat pesanan.</p>

        <div class="grid" style="grid-template-columns: 2fr 1fr;">
            <div class="card">
                <h3>Menu Terlaris (Top 7)</h3>
                <div class="chart-container">
                    <div id="loader-menu" class="chart-loading"><span>Analisis Data Menu...</span></div>
                    <canvas id="chartMenu"></canvas>
                </div>
            </div>
            <div class="card">
                <h3>Leaderboard</h3>
                <ul class="data-list" id="listMenu">
                    <li><span style="color:#666">Menunggu sinkronisasi...</span></li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="slide">
    <div class="dashboard-wrapper">
        <h2>üì¢ Growth Engine: Acquisition</h2>
        <p>Efektivitas kanal marketing dalam mendatangkan member baru.</p>

        <div class="grid" style="grid-template-columns: 1fr 1fr; align-items:center;">
            <div class="card">
                <div class="chart-container" style="height: 350px;">
                    <div id="loader-source" class="chart-loading"><span>Mengambil Data Member...</span></div>
                    <canvas id="chartSource"></canvas>
                </div>
            </div>

            <div style="padding-left: 20px;">
                <div class="kpi-box" style="margin-bottom:20px;">
                    <div class="kpi-label">Total Member Terdaftar</div>
                    <div class="kpi-value text-blue" id="valTotalMember">0</div>
                </div>
                
                <div class="card" style="padding:25px;">
                    <h3 style="font-size:14px; color:#fff; margin-bottom:15px;">Marketing Insight:</h3>
                    <p style="font-size:18px; line-height:1.6;">
                        ‚Ä¢ Dominasi <span class="highlight">TikTok/IG</span>: konten viral bekerja.<br>
                        ‚Ä¢ Dominasi <span class="text-blue">Google Maps</span>: SEO lokal kuat.<br>
                        ‚Ä¢ Fokus budget pada kanal tertinggi.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="slide">
    <div class="dashboard-wrapper">
        <h2>üìç Growth Engine: Geo-Location (Detailed)</h2>
        <p>Peta sebaran domisili pelanggan (Salatiga, Semarang, & Kota Lainnya).</p>

        <div class="grid" style="grid-template-columns: repeat(4, 1fr); gap:15px; margin-bottom:20px;">
            <div class="card" style="padding:15px; text-align:center;">
                <div class="kpi-label">Salatiga</div>
                <div class="kpi-value text-orange" id="geoSalatiga">0%</div>
            </div>
            <div class="card" style="padding:15px; text-align:center;">
                <div class="kpi-label">Kota Smg</div>
                <div class="kpi-value highlight" id="geoSmgKota">0%</div>
            </div>
            <div class="card" style="padding:15px; text-align:center;">
                <div class="kpi-label">Kab. Smg</div>
                <div class="kpi-value text-blue" id="geoKabSmg">0%</div>
            </div>
            <div class="card" style="padding:15px; text-align:center;">
                <div class="kpi-label">Luar Kota</div>
                <div class="kpi-value text-red" id="geoLain">0%</div>
            </div>
        </div>

        <div class="card">
            <h3>Breakdown Wilayah Lengkap</h3>
            <div class="chart-container" style="height: 350px;"> <div id="loader-geo" class="chart-loading"><span>Memetakan Lokasi Detail...</span></div>
                <canvas id="chartGeo"></canvas>
            </div>
        </div>
    </div>
</div>
<div class="slide">
  <h1>Brand Manifesto</h1>
  <p>Kami tidak mengejar viral.</p>
</div>

<div class="slide">
  <p>Kami percaya makan adalah pengalaman.<br>Ruang untuk keluarga. Waktu untuk berbincang.<br>Tempat untuk kembali.</p>
</div>

<div class="slide cinematic" style="background-image:url('https://images.unsplash.com/photo-1572099606223-6e29045d7de3?q=80&w=2070&auto=format&fit=crop');">
  <h1>Dolan Sawah</h1>
  <p>Lebih dari sekadar makan.</p>
</div>

<div class="slide cinematic" style="background-image:url('https://images.unsplash.com/photo-1628189445173-9a3d4f4044c3?q=80&w=2070&auto=format&fit=crop');">
  <h1>Penutup</h1>
  <p><span class="highlight">Viral lewat. Experience tinggal.</span></p>
</div>

<div class="controls">
  <button class="btn-nav" onclick="prevSlide()">‚óÄ</button>
  <button class="btn-nav" onclick="nextSlide()">‚ñ∂</button>
</div>

<div class="footer">
    <span class="status-dot" id="dbIndicator"></span>
    <span id="dbStatusText">Initializing Database...</span>
    <span style="opacity:0.3">|</span>
    <span>Dolan Sawah Intelligence System</span>
</div>
<script>
// =======================================================
// 1. CONFIGURATION: DUAL FIREBASE DATABASE
// =======================================================

// Konfigurasi Database 1: RESERVASI (Untuk Data Omzet & Menu)
const configReservasi = {
  apiKey: "AIzaSyA_c1tU70FM84Qi_f_aSaQ-YVLo_18lCkI",
  authDomain: "reservasi-dolan-sawah.firebaseapp.com",
  projectId: "reservasi-dolan-sawah",
  storageBucket: "reservasi-dolan-sawah.appspot.com",
  messagingSenderId: "213151400721",
  appId: "1:213151400721:web:e51b0d8cdd24206cf682b0"
};

// Konfigurasi Database 2: MEMBER (Untuk Data Member & Source)
const configMember = {
  apiKey: "AIzaSyAEzWDI9ZWlc7NnUTDBbx7wednnUVeS9Ao",
  authDomain: "member-hp-dolansawah.firebaseapp.com",
  projectId: "member-hp-dolansawah",
  storageBucket: "member-hp-dolansawah.appspot.com",
  messagingSenderId: "277683917105",
  appId: "1:277683917105:web:d496ee4547f339e2fee010"
};

// Global Variables
let dbReservasi, dbMember;
let chartInstances = {}; // Menyimpan instance chart agar bisa di-resize/update

// =======================================================
// 2. HELPER FUNCTIONS
// =======================================================

// Robust Date Parser (Handle Firestore Timestamp & String)
function parseDateHelper(dateInput) {
    if (!dateInput) return null;
    
    // Jika input adalah Firestore Timestamp (memiliki method toDate)
    if (typeof dateInput.toDate === 'function') {
        return dateInput.toDate();
    }
    
    // Jika input sudah berupa object Date standard
    if (dateInput instanceof Date) {
        return dateInput;
    }
    
    // Jika input string/number, coba convert
    const parsed = new Date(dateInput);
    if (!isNaN(parsed)) return parsed;
    
    return null;
}

// Professional IDR Formatting
function formatRupiah(number) {
    return new Intl.NumberFormat('id-ID', { 
        style: 'currency', 
        currency: 'IDR',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(number);
}

// UI Helpers: Show/Hide Loaders
function hideLoader(id) {
    const el = document.getElementById(id);
    if(el) el.classList.add('hidden');
}

// =======================================================
// 3. SYSTEM INITIALIZATION
// =======================================================

function initSystem() {
    try {
        // Inisialisasi App Reservasi
        if (!firebase.apps.length) {
            firebase.initializeApp(configReservasi); // Default
        }
        
        // Setup Secondary App for Member DB if needed, or use separate instances
        // Note: SDK 8 allows multiple apps via firebase.initializeApp(config, name)
        const appRes = firebase.initializeApp(configReservasi, "AppReservasi");
        dbReservasi = appRes.firestore();
        
        const appMem = firebase.initializeApp(configMember, "AppMember");
        dbMember = appMem.firestore();
        
        // Update UI Status
        updateStatus("Online: Connected to Dual DB", "online");
        
        // Mulai Tarik Data
        fetchAllData();

    } catch (error) {
        console.error("Initialization Failed:", error);
        // Fallback untuk single app jika error duplicate
        try {
           dbReservasi = firebase.firestore(); 
           updateStatus("Online: Single DB Mode", "online");
           fetchAllData();
        } catch(e) {
           updateStatus("Connection Failed!", "error");
        }
    }
}

function updateStatus(text, statusClass) {
    const dot = document.getElementById('dbIndicator');
    const txt = document.getElementById('dbStatusText');
    if(dot && txt) {
        dot.className = "status-dot " + statusClass;
        txt.innerText = text;
    }
}

// =======================================================
// 4. DATA FETCHING & PROCESSING
// =======================================================

async function fetchAllData() {
    // --- STEP A: Fetch Reservasi ---
    try {
        const snapRes = await dbReservasi.collection('reservations').get();
        const dataRes = snapRes.docs.map(doc => doc.data());
        
        processRevenue(dataRes);
        processMenu(dataRes);
        
    } catch (e) {
        console.error("Error Reservasi:", e);
        updateStatus("Error Reading Reservation DB", "error");
    }

    // --- STEP B: Fetch Member ---
    try {
        const snapMem = await dbMember.collection('members').get();
        const dataMem = snapMem.docs.map(doc => doc.data());
        
        processMemberStats(dataMem);
        processGeo(dataMem); // Updated Logic Here

    } catch (e) {
        console.error("Error Member:", e);
        updateStatus("Error Reading Member DB", "error");
    }
}

// =======================================================
// 5. DATA LOGIC PROCESSORS
// =======================================================

// --- LOGIC 1: Revenue (Chart Line) ---
function processRevenue(data) {
    const months = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Ags", "Sep", "Okt", "Nov", "Des"];
    const revenueData = new Array(12).fill(0);
    let totalRev = 0;

    data.forEach(r => {
        if(r.date && r.dp) {
            const d = parseDateHelper(r.date);
            const val = parseInt(r.dp);
            
            if(d && !isNaN(val)) {
                revenueData[d.getMonth()] += val;
                totalRev += val;
            }
        }
    });

    // Update KPI
    if(document.getElementById('valTotalRes')) document.getElementById('valTotalRes').innerText = data.length.toLocaleString('id-ID');
    if(document.getElementById('valTotalRev')) document.getElementById('valTotalRev').innerText = formatRupiah(totalRev);

    // Render Chart
    hideLoader('loader-revenue');
    const ctx = document.getElementById('chartRevenue');
    if(ctx) {
        chartInstances.revenue = new Chart(ctx, {
            type: 'line',
            data: {
                labels: months,
                datasets: [{
                    label: 'Omzet DP',
                    data: revenueData,
                    borderColor: '#00ff99',
                    backgroundColor: 'rgba(0, 255, 153, 0.15)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 5,
                    pointHoverRadius: 8,
                    pointBackgroundColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: {display: false} },
                scales: {
                    y: { grid: {color:'rgba(255,255,255,0.05)'}, ticks: {callback: v => (v/1000) + 'k', color:'#888'} },
                    x: { grid: {display:false}, ticks: {color:'#ccc'} }
                },
                animation: { duration: 2000, easing: 'easeOutQuart' }
            }
        });
    }
}

// --- LOGIC 2: Menu (Chart Bar Horizontal) ---
function processMenu(data) {
    const menuCount = {};
    
    data.forEach(r => {
        if(Array.isArray(r.menus)) {
            r.menus.forEach(m => {
                const name = m.name;
                const qty = parseInt(m.quantity) || 1;
                menuCount[name] = (menuCount[name] || 0) + qty;
            });
        } 
        else if (r.menu) {
            menuCount[r.menu] = (menuCount[r.menu] || 0) + 1;
        }
    });

    const sorted = Object.entries(menuCount).sort((a,b) => b[1]-a[1]).slice(0, 7);

    // Update List HTML
    const listEl = document.getElementById('listMenu');
    if(listEl) {
        listEl.innerHTML = "";
        sorted.forEach(([name, count]) => {
            listEl.innerHTML += `
                <li>
                    <span style="font-weight:500;">${name}</span>
                    <span class="highlight">${count}</span>
                </li>
            `;
        });
    }

    // Render Chart
    hideLoader('loader-menu');
    const ctx = document.getElementById('chartMenu');
    if(ctx) {
        chartInstances.menu = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: sorted.map(i => i[0].substring(0, 15) + (i[0].length>15 ? '...' : '')),
                datasets: [{
                    label: 'Qty',
                    data: sorted.map(i => i[1]),
                    backgroundColor: '#33ccff',
                    borderRadius: 6
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: {display: false} },
                scales: {
                    x: { grid: {color:'rgba(255,255,255,0.05)'}, ticks: {color:'#888'} },
                    y: { grid: {display:false}, ticks: {color:'#fff', font:{size:11}} }
                },
                animation: { duration: 1500, easing: 'easeOutQuart' }
            }
        });
    }
}

// --- LOGIC 3: Member Source (Chart Doughnut) ---
function processMemberStats(data) {
    if(document.getElementById('valTotalMember')) document.getElementById('valTotalMember').innerText = data.length.toLocaleString('id-ID');

    const sources = {};
    data.forEach(m => {
        let s = (m.sumberInfo || "Lainnya").toLowerCase();
        if(s.includes('ig') || s.includes('instagram')) s = 'Instagram';
        else if(s.includes('tik')) s = 'TikTok';
        else if(s.includes('google') || s.includes('maps')) s = 'Google Maps';
        else s = 'Lainnya';
        
        sources[s] = (sources[s] || 0) + 1;
    });

    hideLoader('loader-source');
    const ctx = document.getElementById('chartSource');
    if(ctx) {
        chartInstances.source = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(sources),
                datasets: [{
                    data: Object.values(sources),
                    backgroundColor: ['#E1306C', '#000000', '#4285F4', '#888'],
                    borderColor: '#222',
                    borderWidth: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: {color:'#fff', padding:20, usePointStyle:true} }
                },
                layout: { padding: 10 },
                cutout: '60%',
                animation: { animateScale: true, animateRotate: true }
            }
        });
    }
}

// --- LOGIC 4: Geo Location (UPDATED: Salatiga, Smg Kota, Kab Smg, & Others) ---
function processGeo(data) {
    // 1. Inisialisasi Kategori Utama
    let stats = {
        'Salatiga': 0,
        'Kota Semarang': 0,
        'Kab. Semarang': 0,
        'Luar Kota': 0
    };
    
    // 2. Map untuk menyimpan detail kota lain secara spesifik
    let otherCitiesMap = {}; 

    data.forEach(m => {
        const addr = (m.alamat || "").toLowerCase();

        // LOGIKA PENYARINGAN KOTA
        if (addr.includes('salatiga')) {
            stats['Salatiga']++;
        } 
        else if (
            (addr.includes('kab') && addr.includes('semarang')) || 
            addr.includes('ungaran') || 
            addr.includes('ambarawa') || 
            addr.includes('bawen') ||
            addr.includes('tuntang')
        ) {
            stats['Kab. Semarang']++;
        }
        else if (addr.includes('semarang')) {
            // Jika ada kata Semarang tapi tidak ada 'kab' atau district kab, masuk Kota
            stats['Kota Semarang']++;
        }
        else {
            // Masuk kategori Luar Kota
            stats['Luar Kota']++;

            // Coba deteksi nama kota spesifik untuk breakdown chart
            let cityFound = 'Lainnya';
            if(addr.includes('boyolali')) cityFound = 'Boyolali';
            else if(addr.includes('solo') || addr.includes('surakarta')) cityFound = 'Solo';
            else if(addr.includes('jogja') || addr.includes('yogyakarta') || addr.includes('sleman')) cityFound = 'Yogyakarta';
            else if(addr.includes('magelang')) cityFound = 'Magelang';
            else if(addr.includes('jakarta')) cityFound = 'Jakarta';
            else if(addr.includes('kendal')) cityFound = 'Kendal';
            else if(addr.includes('demak')) cityFound = 'Demak';
            
            otherCitiesMap[cityFound] = (otherCitiesMap[cityFound] || 0) + 1;
        }
    });

    // 3. Update KPI Angka (Persentase)
    const total = data.length || 1;
    document.getElementById('geoSalatiga').innerText = Math.round((stats['Salatiga']/total)*100) + "%";
    document.getElementById('geoSmgKota').innerText = Math.round((stats['Kota Semarang']/total)*100) + "%";
    document.getElementById('geoKabSmg').innerText = Math.round((stats['Kab. Semarang']/total)*100) + "%";
    document.getElementById('geoLain').innerText = Math.round((stats['Luar Kota']/total)*100) + "%";

    // 4. Siapkan Data Chart (Menggabungkan 3 kategori utama + Top Kota Lain)
    // Urutan: Salatiga, Kota Smg, Kab Smg, ...[Kota Lain Spesifik]...
    
    let chartLabels = ['Salatiga', 'Kota Smg', 'Kab. Smg'];
    let chartData = [stats['Salatiga'], stats['Kota Semarang'], stats['Kab. Semarang']];
    let chartColors = ['#ff9900', '#00ff99', '#33ccff']; // Orange, Green, Blue

    // Urutkan Kota Lain berdasarkan jumlah terbanyak
    const sortedOthers = Object.entries(otherCitiesMap).sort((a,b) => b[1]-a[1]);
    
    // Masukkan Top 3 Kota Lain ke Chart, sisanya 'Lainnya'
    let othersAggregation = 0;
    sortedOthers.forEach(([city, count], index) => {
        if(index < 4 && city !== 'Lainnya') { // Ambil top 4 kota spesifik
            chartLabels.push(city);
            chartData.push(count);
            chartColors.push('#bc13fe'); // Purple untuk kota lain
        } else {
            othersAggregation += count;
        }
    });

    // Tambahkan sisa 'Lainnya' jika ada
    if(othersAggregation > 0) {
        chartLabels.push('Lainnya');
        chartData.push(othersAggregation);
        chartColors.push('#555555');
    }

    hideLoader('loader-geo');
    const ctx = document.getElementById('chartGeo');
    if(ctx) {
        chartInstances.geo = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: 'Jumlah Member',
                    data: chartData,
                    backgroundColor: chartColors,
                    borderRadius: 8,
                    barPercentage: 0.6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: {display: false},
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) { label += ': '; }
                                let value = context.parsed.y;
                                let percentage = ((value / total) * 100).toFixed(1) + "%";
                                return label + value + " (" + percentage + ")";
                            }
                        }
                    }
                },
                scales: {
                    y: { 
                        grid: {color:'rgba(255,255,255,0.05)'}, 
                        ticks: {color:'#888'} 
                    },
                    x: { 
                        grid: {display:false}, 
                        ticks: {color:'#fff', autoSkip: false, maxRotation: 45, minRotation: 0} 
                    }
                },
                animation: {
                    duration: 1500,
                    easing: 'easeOutBack'
                }
            }
        });
    }
}

// =======================================================
// 6. NAVIGATION CONTROLLER
// =======================================================
let slides = document.querySelectorAll('.slide');
let currentSlide = 0;

function showSlide(n) {
    slides.forEach(s => {
        s.classList.remove('active');
        setTimeout(() => {
             if (!s.classList.contains('active')) s.style.display = 'none';
        }, 800); 
    });
    
    currentSlide = (n + slides.length) % slides.length;
    
    const activeSlide = slides[currentSlide];
    activeSlide.style.display = 'flex'; 
    
    requestAnimationFrame(() => {
        setTimeout(() => {
            activeSlide.classList.add('active');
            
            // Force Resize Chart pada elemen tersembunyi agar tidak gepeng
            Object.values(chartInstances).forEach(chart => {
                if (activeSlide.contains(chart.canvas)) {
                    chart.resize(); 
                    chart.update('none'); 
                }
            });
        }, 50); 
    });
}

function nextSlide() { showSlide(currentSlide + 1); }
function prevSlide() { showSlide(currentSlide - 1); }

// Keyboard Listener
document.addEventListener('keydown', (e) => {
    if(e.key === "ArrowRight" || e.key === " " || e.key === "Enter") nextSlide();
    if(e.key === "ArrowLeft") prevSlide();
});

// Jalankan Sistem
initSystem();

</script>
</body>
</html>
